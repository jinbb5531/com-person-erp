<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.person.erp.order.dao.IOrderDAO">
    <resultMap id="BaseResult" type="com.person.erp.order.entity.Order">
        <id column="ORDER_CODE" property="orderCode" jdbcType="VARCHAR"/>
        <result column="CUSTOMER" property="customer" jdbcType="VARCHAR"/>
        <result column="CREATE_AT" property="createAt" jdbcType="TIMESTAMP"/>
        <result column="CREATE_BY" property="createBy" jdbcType="VARCHAR"/>
        <result column="UPDATE_AT" property="updateAt" jdbcType="TIMESTAMP"/>
        <result column="ORDER_STATUS" property="status" jdbcType="INTEGER"/>
        <result column="CUTTER" property="cutter" jdbcType="VARCHAR"/>
        <result column="HEMMER" property="hemmer" jdbcType="VARCHAR"/>
        <result column="PACKER" property="packer" jdbcType="VARCHAR"/>
        <result column="DEADLINE" property="deadline" jdbcType="TIMESTAMP"/>
        <result column="SYSTEM_TAG" property="systemTag" jdbcType="BIGINT"/>
        <result column="REMARK" property="remark" jdbcType="VARCHAR"/>
        <result column="CUT_AT" property="cutAt" jdbcType="TIMESTAMP"/>
        <result column="HEM_AT" property="hemAt" jdbcType="TIMESTAMP"/>
        <result column="PACK_AT" property="packAt" jdbcType="TIMESTAMP"/>
        <collection property="itemList" ofType="com.person.erp.order.entity.OrderItem">
            <id column="CODE" property="code" jdbcType="BIGINT"/>
            <result column="NAME" property="name" jdbcType="VARCHAR"/>
            <result column="COLOR" property="color" jdbcType="VARCHAR"/>
            <result column="SIZE_L" property="sizeL" jdbcType="DOUBLE"/>
            <result column="SIZE_W" property="sizeW" jdbcType="DOUBLE"/>
            <result column="PRO_SIZE_L" property="proSizeL" jdbcType="DOUBLE"/>
            <result column="PRO_SIZE_W" property="proSizeW" jdbcType="DOUBLE"/>
            <result column="NUMBER" property="number" jdbcType="INTEGER"/>
            <result column="PLANT_NUM" property="plantNum" jdbcType="INTEGER"/>
        </collection>
    </resultMap>
    <resultMap id="baseOrder" type="com.person.erp.order.entity.Order">
        <id column="ORDER_CODE" property="orderCode" jdbcType="VARCHAR"/>
        <result column="CUSTOMER" property="customer" jdbcType="VARCHAR"/>
        <result column="CREATE_AT" property="createAt" jdbcType="TIMESTAMP"/>
        <result column="CREATE_BY" property="createBy" jdbcType="VARCHAR"/>
        <result column="UPDATE_AT" property="updateAt" jdbcType="TIMESTAMP"/>
        <result column="ORDER_STATUS" property="status" jdbcType="INTEGER"/>
        <result column="CUTTER" property="cutter" jdbcType="VARCHAR"/>
        <result column="HEMMER" property="hemmer" jdbcType="VARCHAR"/>
        <result column="PACKER" property="packer" jdbcType="VARCHAR"/>
        <result column="DEADLINE" property="deadline" jdbcType="TIMESTAMP"/>
        <result column="SYSTEM_TAG" property="systemTag" jdbcType="BIGINT"/>
        <result column="REMARK" property="remark" jdbcType="VARCHAR"/>
        <result column="CUT_AT" property="cutAt" jdbcType="TIMESTAMP"/>
        <result column="HEM_AT" property="hemAt" jdbcType="TIMESTAMP"/>
        <result column="PACK_AT" property="packAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="baseColumn">
        ORDER_CODE,  CUSTOMER, CREATE_AT, CREATE_BY, UPDATE_AT, ORDER_STATUS, CUTTER, HEMMER, PACKER, DEADLINE, SYSTEM_TAG, REMARK,
        CUT_AT, HEM_AT,PACK_AT
    </sql>
    <update id="update" parameterType="com.person.erp.order.entity.Order">
        UPDATE ERP_ORDER
        <set>
            <if test="customer != null">
                CUSTOMER = #{customer},
            </if>
            <if test="updateAt != null">
                UPDATE_AT = #{updateAt},
            </if>
            <if test="status != null">
                ORDER_STATUS = #{status},
            </if>
            <if test="updateAt != null">
                UPDATE_AT = #{updateAt},
            </if>
            <if test="cutter != null">
                CUTTER = #{cutter},
            </if>
            <if test="hemmer != null">
                HEMMER = #{hemmer},
            </if>
            <if test="packer != null">
                PACKER = #{packer},
            </if>
            <if test="deadline != null">
                DEADLINE = #{deadline},
            </if>
            <if test="remark != null">
                REMARK = #{remark}
            </if>
            <if test="cutAt != null">
                CUT_AT = #{cutAt}
            </if>
            <if test="hemAt != null">
                HEM_AT = #{hemAt}
            </if>
            <if test="packAt">
                PACK_AT = #{packAt}
            </if>
        </set>
        WHERE ORDER_CODE = #{orderCode}
        AND SYSTEM_TAG = #{systemTag}
    </update>
    <insert id="insert" parameterType="com.person.erp.order.entity.Order">
        <selectKey keyColumn="ORDER_CODE" keyProperty="orderCode" order="BEFORE" resultType="java.lang.String">
            SELECT REPLACE(UUID(),'-','')
        </selectKey>
        INSERT INTO ERP_ORDER
        (ORDER_CODE, CUSTOMER, CREATE_AT, CREATE_BY, UPDATE_AT, ORDER_STATUS, CUTTER, HEMMER, PACKER, DEADLINE,
        SYSTEM_TAG, REMARK, CUT_AT, HEM_AT, PACK_AT)
        VALUES(
        #{orderCode},
        #{customer},
        #{createAt},
        #{createBy},
        #{updateAt},
        #{status},
        #{cutter},
        #{hemmer},
        #{packer},
        #{deadline},
        #{systemTag},
        #{remark},
        #{cutAt},
        #{hemAt},
        #{packAt}
        )
    </insert>
    <delete id="delete" parameterType="com.person.erp.order.entity.Order">
        DELETE FROM ERP_ORDER
        WHERE ORDER_CODE = #{orderCode} AND SYSTEM_TAG = #{systemTag}
    </delete>
    <delete id="deleteBatch">
        DELETE FROM ERP_ORDER
        WHERE
        ORDER_CODE IN
        <foreach collection="array" open="(" separator="," close=")" item="id">
            #{id}
        </foreach>
    </delete>
    <select id="findById" parameterType="com.person.erp.order.model.OrderDTO" resultMap="BaseResult">
        SELECT *
        FROM ERP_ORDER o LEFT JOIN ERP_ORDER_ITEM e
        ON o.ORDER_CODE = e.ORDER_CODE
        WHERE o.ORDER_CODE = #{orderCode}
        AND SYSTEM_TAG = #{systemTag}
    </select>
    <select id="findPage" parameterType="com.person.erp.order.model.OrderDTO" resultMap="baseOrder">
        SELECT
        <include refid="baseColumn"/>
        FROM ERP_ORDER
        WHERE
        <if test="orderCode != null">
            ORDER_CODE = #{orderCode} AND
        </if>
        <if test="customer != null">
            CUSTOMER = #{customer} AND
        </if>
        SYSTEM_TAG = #{systemTag} AND
        1=1
        ORDER BY DEADLINE DESC
    </select>
</mapper>
